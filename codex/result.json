{
  "task": "以下のLINE認証実装計画をレビューしてください。セキュリティ、設計の妥当性、潜在的な問題点を指摘してください。",
  "sharedContext": "# Sprint 2: LINE認証実装計画\n\n## 概要\n\nSupabase Authを削除し、LINE Login + JWT (jose) による独自認証に変更。\n参照実装: `~/Documents/train-canvas/server/_core/`\n\n## 変更方針\n\n| 項目 | Before | After |\n|------|--------|-------|\n| 認証 | Supabase Auth | LINE Login + JWT |\n| DB接続 | Supabase Client | Drizzle + postgres直接 |\n| セッション | Supabase Session | JWT Cookie |\n| ユーザーID | supabase_uid | openId (LINE userId) |\n\n## 実装タスク\n\n### 2.1 Supabase削除・DB接続変更\n\n**削除ファイル**:\n- `src/utils/supabase/client.ts`\n- `src/utils/supabase/server.ts`\n- `src/utils/supabase/middleware.ts`\n\n**更新ファイル**:\n- `src/db/schema.ts` - `supabaseUid` → `openId` に変更\n- `.env.example` - Supabase変数削除、LINE変数追加\n- `package.json` - `@supabase/*` 削除、`jose` `nanoid` 追加\n\n### 2.2 LINE認証コア実装\n**参照**: `~/Documents/train-canvas/server/_core/lineAuth.ts`\n\n**新規ファイル**: `src/lib/auth/line.ts`\n```typescript\n// LINE API通信\ngetLineAuthUrl(state, redirectUri): string\ngetLineToken(code, redirectUri): Promise<TokenData>\ngetLineProfile(accessToken): Promise<Profile>\nverifyLineToken(idToken): Promise<IdTokenData>\n```\n\n### 2.3 JWT セッション管理\n**参照**: `~/Documents/train-canvas/server/_core/sdk.ts`\n\n**新規ファイル**: `src/lib/auth/session.ts`\n```typescript\ncreateSessionToken(openId, options): Promise<string>\nverifySession(token): Promise<SessionPayload | null>\ngetCurrentUser(cookies): Promise<User | null>\n```\n\n### 2.4 認証ルートハンドラー\n**参照**: `~/Documents/train-canvas/server/_core/lineAuthRoutes.ts`\n\n**新規ファイル**:\n- `src/app/api/auth/line/route.ts` - ログイン開始\n- `src/app/api/auth/line/callback/route.ts` - コールバック処理\n- `src/app/api/auth/logout/route.ts` - ログアウト\n\n### 2.5 Middleware更新\n\n**更新ファイル**: `src/middleware.ts`\n- JWT Cookie検証に変更\n- 保護ルート: `/create`, `/mypage`, `/reservations`\n- Admin保護: `/admin`\n\n### 2.6 ログインページ\n\n**新規ファイル**: `src/app/(public)/login/page.tsx`\n- LINE Loginボタンのみ\n- シンプルなUI\n\n### 2.7 DBユーザー操作\n\n**新規ファイル**: `src/lib/services/user.ts`\n```typescript\nupsertUser(data): Promise<void>\ngetUserByOpenId(openId): Promise<User | null>\nisAdmin(openId): Promise<boolean>\n```\n\n## ファイル構成 (最終)\n\n```\nsrc/\n├── app/\n│   ├── (public)/\n│   │   └── login/page.tsx           # 新規\n│   └── api/\n│       └── auth/\n│           ├── line/route.ts        # 新規\n│           ├── line/callback/route.ts # 新規\n│           └── logout/route.ts      # 新規\n├── lib/\n│   ├── auth/\n│   │   ├── line.ts                  # 新規\n│   │   ├── session.ts               # 新規\n│   │   └── constants.ts             # 新規\n│   └── services/\n│       └── user.ts                  # 新規\n├── db/\n│   ├── index.ts                     # 更新\n│   └── schema.ts                    # 更新 (openId)\n├── middleware.ts                    # 更新 (JWT検証)\n└── utils/\n    └── supabase/                    # 削除\n```\n\n## 環境変数 (.env.example)\n\n```env\n# Database\nDATABASE_URL=postgresql://user:pass@host:5432/db\n\n# LINE Login\nLINE_CHANNEL_ID=your-channel-id\nLINE_CHANNEL_SECRET=your-channel-secret\n\n# JWT\nJWT_SECRET=your-jwt-secret-key\n\n# App\nNEXT_PUBLIC_APP_URL=http://localhost:3000\nOWNER_OPEN_ID=admin-line-user-id\n```\n\n## スキーマ変更\n\n```typescript\n// Before\nsupabaseUid: varchar(\"supabase_uid\", { length: 64 }).notNull().unique()\n\n// After\nopenId: varchar(\"open_id\", { length: 64 }).notNull().unique()\nloginMethod: varchar(\"login_method\", { length: 64 }).default(\"line\")\nlastSignedIn: timestamp(\"last_signed_in\").defaultNow()\n```\n\n## 検証手順\n\n1. `npm run dev` で起動\n2. `/login` → LINE Loginボタンクリック\n3. LINE認証 → コールバック → `/mypage` にリダイレクト\n4. Cookie `app_session_id` が設定されていることを確認\n5. 保護ルート `/create` にアクセス可能\n6. ログアウト → Cookie削除 → `/login` にリダイレクト\n7. `npm run build` 成功\n\n## 必要なLINE設定\n\nLINE Developers Console:\n1. Messaging API チャネル作成\n2. LINE Login 有効化\n3. Callback URL: `{APP_URL}/api/auth/line/callback`\n4. Scope: `profile openid email`\n",
  "codex": {
    "status": "fulfilled",
    "content": "**Findings**\n- Critical: Missing CSRF/state verification details for LINE OAuth. `state` must be generated per request, stored server-side (or signed), and verified in callback to prevent login CSRF; plan doesn’t mention storage or verification.\n- Critical: JWT cookie security attributes not specified. Must set `HttpOnly`, `Secure` (prod), `SameSite=Lax` or `Strict`, `Path=/`, and consider `Max-Age`/`Expires`. Missing increases XSS/session fixation risk.\n- High: No refresh/rotation strategy. If JWT is long-lived and stored in cookie, compromise = long access; if short-lived, you need refresh flow or re-login UX. Plan doesn’t specify TTL or rotation.\n- High: ID token validation requirements not spelled out. LINE ID token must be verified with issuer/audience/nonce, signature, and `exp`. Plan only mentions `verifyLineToken` but not required claims.\n- High: OpenId as primary user ID could change if LINE account deleted/recreated; consider stable internal UUID and map `openId` to it to avoid orphan data and enable future auth methods.\n- Medium: Admin auth based on `OWNER_OPEN_ID` in env risks manual mistakes and hard‑to‑audit access. Consider a DB role table, or at least validate on startup and log mismatches.\n- Medium: Logout route should also revoke LINE access token if stored and clear cookie with same attributes used on set; plan doesn’t mention token revocation.\n- Medium: `getLineProfile` call likely needs access token; if token isn’t stored or refreshed, profile fetch failures will break user data updates. Clarify what’s persisted.\n- Low: `loginMethod` default “line” but no plan for migration/backfill or uniqueness constraints when switching existing supabase users.\n- Low: `lastSignedIn` uses `defaultNow()` but should be updated on every login; default alone won’t update.\n\n**Open questions / assumptions**\n- Are you storing LINE access/refresh tokens? If yes, need encryption at rest and rotation; if no, what data are you using to populate user profile?\n- How will you handle email scope unavailability or user denial (LINE often omits email)?\n- Do you need multi-device sessions or a single session per user? That affects token invalidation strategy.\n\n**Change summary (what’s solid)**\n- Plan is directionally fine: replace Supabase Auth with LINE Login + JWT, update middleware, and centralize auth/session logic under `src/lib/auth`.\n\n**Suggested next steps**\n1) Specify OAuth state/nonce storage + verification strategy for LINE callback.  \n2) Define JWT cookie attributes and TTL/rotation policy.  \n3) Document ID token validation requirements and claim checks.  \n4) Decide on internal user ID vs `openId` mapping for future‑proofing.\n"
  },
  "outputDir": "/Users/altis/Documents/wrapping-the-train/codex",
  "timestamp": "2026-01-13T06:52:58.825Z"
}